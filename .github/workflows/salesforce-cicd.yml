name: Salesforce CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli

      - name: Install Salesforce Code Analyzer
        run: |
          npm install -g @salesforce/sfdx-scanner

      - name: Run Code Analyzer
        id: scanner
        continue-on-error: true
        run: |
          sf scanner run \
            --target "force-app" \
            --format "csv" \
            --outfile "scanner-results.csv" \
            --severity-threshold 1 \
            --engine "eslint-lwc,eslint-typescript,pmd,retire-js,cpd" || SCANNER_EXIT_CODE=$?
          
          # Exit code 1 means violations found, which is expected behavior
          if [ "${SCANNER_EXIT_CODE:-0}" -eq 1 ]; then
            echo "violations_found=true" >> $GITHUB_OUTPUT
          else
            echo "violations_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Sev1 violations
        run: |
          if [ "${{ steps.scanner.outputs.violations_found }}" == "true" ]; then
            echo "❌ Sev1 violations found. Build failed."
            if [ -f scanner-results.csv ]; then
              echo "Scanner Results:"
              cat scanner-results.csv
            fi
            exit 1
          else
            echo "✅ No Sev1 violations found."
          fi

      - name: Upload scanner results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scanner-results
          path: scanner-results.csv
          retention-days: 30

  deploy:
    name: Deploy to Salesforce
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli

      - name: Authenticate to Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          if [ -z "$SFDX_AUTH_URL" ]; then
            echo "❌ SFDX_AUTH_URL secret is not set"
            exit 1
          fi
          
          # Create temporary file for auth URL
          echo "$SFDX_AUTH_URL" > /tmp/auth-url.txt
          
          # Authenticate using sf CLI with correct flags
          sf org login sfdx-url \
            --sfdx-url-file /tmp/auth-url.txt \
            --alias ci-org \
            --set-default
          
          # Clean up auth file
          rm /tmp/auth-url.txt

      - name: Display authenticated org
        run: |
          sf org display --target-org ci-org

      - name: Deploy to Salesforce
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org ci-org \
            --test-level RunLocalTests \
            --wait 10

      - name: Get deployment details
        if: always()
        run: |
          sf project deploy report \
            --target-org ci-org \
            --json > deployment-report.json || true

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.json
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/test-results/*.xml
            **/test-results/*.json
          retention-days: 30
          if-no-files-found: ignore
