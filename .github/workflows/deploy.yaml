name: Salesforce Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Salesforce Code Analyzer
        id: code-analyzer
        uses: forcedotcom/run-code-analyzer@v2
        with:
          run-arguments: --target force-app
          results-artifact-name: code-analyzer-results
          
      - name: Check for Critical Violations
        run: |
          if [ "${{ steps.code-analyzer.outputs.num-sev1-violations }}" -gt 0 ]; then
            echo "❌ Critical violations found: ${{ steps.code-analyzer.outputs.num-sev1-violations }}"
            echo "Total violations: ${{ steps.code-analyzer.outputs.num-violations }}"
            exit 1
          else
            echo "✅ No critical violations found"
            echo "Total violations: ${{ steps.code-analyzer.outputs.num-violations }}"
          fi
          
      - name: Upload Code Analyzer Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-analyzer-results
          path: |
            sfca_results.json
            sfca_results.html
          retention-days: 30
          overwrite: true

  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Salesforce CLI
        uses: salesforce/setup-sfdx@v4
        
      - name: Authenticate Salesforce Org
        uses: salesforce/sfdx-action@v4
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL }}
          
      - name: Validate Deployment with Local Tests
        id: validate-deploy
        uses: salesforce/sfdx-action@v4
        with:
          command: |
            sf project deploy start \
              --source-dir force-app \
              --test-level RunLocalTests \
              --wait 10 \
              --dry-run \
              --json > deploy-validate-report.json
              
      - name: Display Validation Results
        run: |
          if [ -f deploy-validate-report.json ]; then
            cat deploy-validate-report.json
            # Check if validation failed by looking for error indicators
            if grep -q '"status": 1' deploy-validate-report.json || \
               grep -q '"status": "Failed"' deploy-validate-report.json || \
               grep -q '"success": false' deploy-validate-report.json; then
              echo "Validation failed"
              exit 1
            fi
            echo "Validation completed successfully"
          else
            echo "Validation report not found"
            exit 1
          fi
          
      - name: Upload Validation Report Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: deploy-validate-report.json
          retention-days: 30

  deploy:
    name: Deploy to Salesforce
    runs-on: ubuntu-latest
    needs: [code-quality, validate]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Salesforce CLI
        uses: salesforce/setup-sfdx@v4
        
      - name: Authenticate Salesforce Org
        uses: salesforce/sfdx-action@v4
        with:
          sfdx-auth-url: ${{ secrets.SFDX_AUTH_URL }}
          
      - name: Deploy to Salesforce Org
        id: deploy
        uses: salesforce/sfdx-action@v4
        with:
          command: |
            sf project deploy start \
              --source-dir force-app \
              --wait 10 \
              --json > deploy-report.json
              
      - name: Display Deployment Results
        run: |
          if [ -f deploy-report.json ]; then
            cat deploy-report.json
            # Check if deployment failed by looking for error indicators
            if grep -q '"status": 1' deploy-report.json || \
               grep -q '"status": "Failed"' deploy-report.json || \
               grep -q '"success": false' deploy-report.json; then
              echo "Deployment failed"
              exit 1
            fi
            echo "Deployment completed successfully"
          else
            echo "Deployment report not found"
            exit 1
          fi
          
      - name: Upload Deployment Report Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-report
          path: deploy-report.json
          retention-days: 30

