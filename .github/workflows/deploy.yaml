name: Salesforce Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        timeout-minutes: 5
        run: |
          echo "Installing Salesforce CLI..."
          npm install --global @salesforce/cli@latest
          sf --version
          echo "✅ Salesforce CLI installed successfully"

      - name: Authenticate to Salesforce org
        timeout-minutes: 3
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          if [ -z "$SFDX_AUTH_URL" ]; then
            echo "::error::SFDX_AUTH_URL secret is not set"
            echo "::error::Configure it at: Settings > Secrets and variables > Actions"
            exit 1
          fi
          echo "Authenticating to Salesforce org..."
          echo "$SFDX_AUTH_URL" | sf org login sfdx-url --alias deploy-org --set-default-username
          echo "✅ Authentication successful"

      - name: Validate deployment
        id: validate
        timeout-minutes: 15
        run: |
          echo "Running deployment validation with RunLocalTests..."
          sf project deploy validate \
            --source-dir force-app \
            --test-level RunLocalTests \
            --wait 10 \
            --json > validation-report.json 2>&1 || true

          if [ ! -f validation-report.json ] || ! jq empty validation-report.json 2>/dev/null; then
            echo "::error::Validation report invalid or not created"
            [ -f validation-report.json ] && cat validation-report.json
            echo "validation_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          VALIDATION_STATUS=$(jq -r '.status // "unknown"' validation-report.json)
          echo "Validation status: $VALIDATION_STATUS"

          jq '.' validation-report.json

          if [[ "$VALIDATION_STATUS" == "Succeeded"* ]]; then
            echo "validation_success=true" >> $GITHUB_OUTPUT
            echo "✅ Validation passed successfully"
          else
            echo "validation_success=false" >> $GITHUB_OUTPUT
            echo "::error::Validation failed with status: $VALIDATION_STATUS"
            exit 1
          fi

      - name: Deploy to Salesforce org
        id: deploy
        if: steps.validate.outputs.validation_success == 'true'
        timeout-minutes: 15
        run: |
          echo "Deploying to Salesforce org..."
          sf project deploy start \
            --source-dir force-app \
            --test-level RunLocalTests \
            --wait 10 \
            --json > deployment-report.json 2>&1 || true

          if [ ! -f deployment-report.json ] || ! jq empty deployment-report.json 2>/dev/null; then
            echo "::error::Deployment report invalid or not created"
            [ -f deployment-report.json ] && cat deployment-report.json
            echo "deployment_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          DEPLOYMENT_STATUS=$(jq -r '.status // "unknown"' deployment-report.json)
          DEPLOYMENT_ID=$(jq -r '.result.id // "unknown"' deployment-report.json)

          echo "Deployment status: $DEPLOYMENT_STATUS"
          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

          jq '.' deployment-report.json

          if [[ "$DEPLOYMENT_STATUS" == "Succeeded"* ]]; then
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            echo "✅ Deployment completed successfully"
          else
            echo "deployment_success=false" >> $GITHUB_OUTPUT
            echo "::error::Deployment failed with status: $DEPLOYMENT_STATUS"
            exit 1
          fi

      - name: Upload deployment report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.run_number }}
          path: |
            validation-report.json
            deployment-report.json
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      - name: Deployment summary
        if: always()
        run: |
          {
            echo "## Salesforce Deployment Summary"
            echo ""
            echo "**Branch:** \`${{ github.ref_name }}\`"
            echo "**Commit:** \`${{ github.sha }}\`"
            echo "**Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          VALIDATION_SUCCESS="${{ steps.validate.outputs.validation_success }}"
          DEPLOYMENT_SUCCESS="${{ steps.deploy.outputs.deployment_success }}"
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"

          if [ -f validation-report.json ]; then
            VALIDATION_STATUS=$(jq -r '.status // "unknown"' validation-report.json)
            {
              echo "### Validation Results"
              echo ""
              echo "**Status:** \`$VALIDATION_STATUS\`"
              echo ""
              echo "<details><summary>View validation details</summary>"
              echo ""
              echo '```json'
              jq '.' validation-report.json 2>/dev/null || cat validation-report.json
              echo '```'
              echo ""
              echo "</details>"
              echo ""
            } >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f deployment-report.json ]; then
            DEPLOYMENT_STATUS=$(jq -r '.status // "unknown"' deployment-report.json)
            {
              echo "### Deployment Results"
              echo ""
              echo "**Status:** \`$DEPLOYMENT_STATUS\`"
              [ "$DEPLOYMENT_ID" != "unknown" ] && echo "**Deployment ID:** \`$DEPLOYMENT_ID\`"
              echo ""
              echo "<details><summary>View deployment details</summary>"
              echo ""
              echo '```json'
              jq '.' deployment-report.json 2>/dev/null || cat deployment-report.json
              echo '```'
              echo ""
              echo "</details>"
              echo ""
            } >> $GITHUB_STEP_SUMMARY
          fi

          {
            echo "---"
            echo ""
            if [ "$VALIDATION_SUCCESS" = "true" ] && [ "$DEPLOYMENT_SUCCESS" = "true" ]; then
              echo "### ✅ Deployment Successful"
            elif [ "$VALIDATION_SUCCESS" != "true" ]; then
              echo "### ❌ Validation Failed"
            elif [ "$DEPLOYMENT_SUCCESS" != "true" ]; then
              echo "### ❌ Deployment Failed"
            else
              echo "### ⚠️ Deployment Status Unknown"
            fi
          } >> $GITHUB_STEP_SUMMARY