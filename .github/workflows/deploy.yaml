name: Salesforce Deploy

on:
  push:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install Salesforce Code Analyzer Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Run Salesforce Code Analyzer
        id: scanner
        run: |
          sf scanner run \
            --target force-app \
            --format json \
            --outfile code-analysis-results.json \
            --severity-threshold 1 || true

      - name: Upload Code Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-report
          path: code-analysis-results.json
          retention-days: 30

      - name: Check for Critical Violations
        run: |
          if [ ! -f code-analysis-results.json ]; then
            echo "::error::Code analysis results file not found"
            exit 1
          fi
          
          # Check if jq is available, install if not
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Count critical violations (severity 1)
          violations=$(jq '[.violations[]? | select(.severity == 1)] | length' code-analysis-results.json 2>/dev/null || echo "0")
          
          if [ "$violations" -gt 0 ]; then
            echo "::error::Code quality check failed with $violations critical violation(s)"
            echo "Critical violations found: $violations"
            jq '[.violations[]? | select(.severity == 1)]' code-analysis-results.json
            exit 1
          else
            echo "âœ… No critical violations found"
          fi

  deploy:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate Salesforce Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > /tmp/sfdx-auth-url.txt
          sf org login sfdx-url --sfdx-url-file /tmp/sfdx-auth-url.txt --alias deploy-org --no-prompt
          rm -f /tmp/sfdx-auth-url.txt

      - name: Validate Deployment with Local Tests
        id: validate
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          set +e
          sf project deploy validate \
            --source-dir force-app \
            --test-level RunLocalTests \
            --target-org deploy-org \
            --wait 10 \
            --json > deployment-report.json 2>&1
          exit_code=$?
          
          # Display the deployment report for debugging
          if [ -f deployment-report.json ]; then
            echo "Deployment validation report:"
            cat deployment-report.json | jq '.' 2>/dev/null || cat deployment-report.json
          fi
          
          if [ $exit_code -ne 0 ]; then
            echo "::error::Deployment validation failed with exit code $exit_code"
            # Try to extract error message from JSON
            if [ -f deployment-report.json ]; then
              error_msg=$(jq -r '.result.errors[0].message // .result.message // .message // "Unknown error"' deployment-report.json 2>/dev/null || echo "Check deployment-report.json for details")
              echo "::error::$error_msg"
            fi
            exit $exit_code
          fi

      - name: Deploy to Salesforce Org
        if: steps.validate.outcome == 'success'
        run: |
          set +e
          sf project deploy start \
            --source-dir force-app \
            --target-org deploy-org \
            --wait 10 \
            --json > deployment-report.json 2>&1
          exit_code=$?
          
          # Display the deployment report
          if [ -f deployment-report.json ]; then
            echo "Deployment report:"
            cat deployment-report.json | jq '.' 2>/dev/null || cat deployment-report.json
          fi
          
          if [ $exit_code -ne 0 ]; then
            echo "::error::Deployment failed with exit code $exit_code"
            if [ -f deployment-report.json ]; then
              error_msg=$(jq -r '.result.errors[0].message // .result.message // .message // "Unknown error"' deployment-report.json 2>/dev/null || echo "Check deployment-report.json for details")
              echo "::error::$error_msg"
            fi
            exit $exit_code
          fi

      - name: Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.json
          retention-days: 30