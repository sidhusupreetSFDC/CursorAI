name: Salesforce Deploy

on:
  push:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install Salesforce Code Analyzer Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Run Salesforce Code Analyzer
        id: scanner
        run: |
          sf scanner run \
            --target force-app \
            --format json \
            --outfile code-analysis-results.json \
            --severity-threshold 1 || true

      - name: Upload Code Analysis Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-report
          path: code-analysis-results.json
          retention-days: 30

      - name: Check for Critical Violations
        run: |
          if [ ! -f code-analysis-results.json ]; then
            echo "::error::Code analysis results file not found"
            exit 1
          fi
          
          # Check if jq is available, install if not
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Count critical violations (severity 1)
          violations=$(jq '[.violations[]? | select(.severity == 1)] | length' code-analysis-results.json 2>/dev/null || echo "0")
          
          if [ "$violations" -gt 0 ]; then
            echo "::error::Code quality check failed with $violations critical violation(s)"
            echo "Critical violations found: $violations"
            jq '[.violations[]? | select(.severity == 1)]' code-analysis-results.json
            exit 1
          else
            echo "âœ… No critical violations found"
          fi

  deploy:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate Salesforce Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" | sf org login sfdx-url --sfdx-url-file stdin --alias deploy-org --no-prompt

      - name: Validate Deployment with Local Tests
        id: validate
        run: |
          sf project deploy validate \
            --source-dir force-app \
            --test-level RunLocalTests \
            --target-org deploy-org \
            --wait 10 \
            --json > deployment-report.json

      - name: Deploy to Salesforce Org
        if: steps.validate.outcome == 'success'
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org deploy-org \
            --wait 10 \
            --json > deployment-report.json

      - name: Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.json
          retention-days: 30