name: Salesforce Deploy

on:
  push:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Java for PMD
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install PMD
        run: |
          PMD_VERSION="7.0.0"
          wget -q https://github.com/pmd/pmd/releases/download/pmd_releases%2F${PMD_VERSION}/pmd-bin-${PMD_VERSION}.zip
          unzip -q pmd-bin-${PMD_VERSION}.zip
          sudo mv pmd-bin-${PMD_VERSION} /opt/pmd
          sudo ln -s /opt/pmd/bin/pmd /usr/local/bin/pmd
          pmd --version
      
      - name: Install Salesforce Scanner
        run: |
          npm install -g @salesforce/sfdx-scanner
          sfdx scanner --version
      
      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Salesforce Scanner
        run: |
          sfdx scanner:run \
            --target force-app \
            --format json \
            --severity-threshold 3 \
            --engine pmd \
            --engine eslint \
            --engine retire-js \
            --json > scanner-report.json || SCANNER_EXIT_CODE=$?
          
          # Check for critical violations
          if [ -f scanner-report.json ]; then
            CRITICAL_COUNT=$(cat scanner-report.json | jq -r '[.result.violations[]? | select(.severity == 1)] | length // 0')
            HIGH_COUNT=$(cat scanner-report.json | jq -r '[.result.violations[]? | select(.severity == 2)] | length // 0')
            
            echo "Critical violations: $CRITICAL_COUNT"
            echo "High severity violations: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "❌ Found $CRITICAL_COUNT critical violation(s). Failing build."
              cat scanner-report.json | jq '.result.violations[]? | select(.severity == 1)'
              exit 1
            fi
            
            echo "✅ No critical violations found"
            cat scanner-report.json | jq '.result.summary'
          else
            echo "Scanner report not generated"
            exit 1
          fi
      
      - name: Run PMD Analysis
        run: |
          # Run PMD on Apex classes
          pmd check \
            --dir force-app/main/default/classes \
            --rulesets rulesets/apex/quickstart.xml,rulesets/apex/security.xml \
            --format json \
            --fail-on-violation false \
            > pmd-report.json 2>&1 || PMD_EXIT_CODE=$?
          
          # Check for critical violations in PMD report
          if [ -f pmd-report.json ]; then
            # Check if PMD found any violations (priority 1 = critical/blocker)
            CRITICAL_COUNT=$(cat pmd-report.json | jq -r '[.files[]?.violations[]? | select(.priority == 1)] | length // 0' 2>/dev/null || echo "0")
            
            echo "PMD Critical violations: $CRITICAL_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "❌ Found $CRITICAL_COUNT critical PMD violation(s). Failing build."
              cat pmd-report.json | jq '.files[]?.violations[]? | select(.priority == 1)' 2>/dev/null || cat pmd-report.json
              exit 1
            fi
            
            echo "✅ No critical PMD violations found"
            cat pmd-report.json | jq '.summary' 2>/dev/null || echo "PMD analysis completed"
          else
            echo "PMD report not generated, but continuing..."
          fi
      
      - name: Upload code quality reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            scanner-report.json
            pmd-report.json
          retention-days: 30
  
  deploy:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version
      
      - name: Authenticate Salesforce org
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > /tmp/auth.txt
          sf org login sfdx-url --sfdx-url-file /tmp/auth.txt --alias deploy-org
          rm /tmp/auth.txt
      
      - name: Validate deployment with tests
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org deploy-org \
            --test-level RunLocalTests \
            --wait 10 \
            --json > deployment-report.json || DEPLOY_EXIT_CODE=$?
          
          # Check if deployment-report.json exists and has content
          if [ ! -f deployment-report.json ] || [ ! -s deployment-report.json ]; then
            echo "Deployment command failed to generate report"
            exit 1
          fi
      
      - name: Check deployment status
        run: |
          # Install jq for JSON parsing if not available
          sudo apt-get update && sudo apt-get install -y jq || true
          
          # Parse deployment status from JSON report
          if [ -f deployment-report.json ]; then
            DEPLOYMENT_STATUS=$(cat deployment-report.json | jq -r '.status // "unknown"')
            DEPLOYMENT_RESULT=$(cat deployment-report.json | jq -r '.result.status // "unknown"')
            
            echo "Deployment Status Code: $DEPLOYMENT_STATUS"
            echo "Deployment Result: $DEPLOYMENT_RESULT"
            
            # Check if deployment succeeded
            if [ "$DEPLOYMENT_STATUS" != "0" ] || [ "$DEPLOYMENT_RESULT" != "Succeeded" ]; then
              echo "Deployment failed or had warnings"
              cat deployment-report.json | jq '.'
              exit 1
            else
              echo "Deployment succeeded successfully"
              cat deployment-report.json | jq '.result.numberComponentErrors, .result.numberTestsCompleted, .result.numberTestsFailed'
            fi
          else
            echo "Deployment report not found"
            exit 1
          fi
      
      - name: Upload deployment report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.json
          retention-days: 30