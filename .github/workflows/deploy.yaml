name: Salesforce Deploy

on:
  push:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '>=20.9.0'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '>=11'
          distribution: 'zulu'
      
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest
      
      - name: Install Salesforce Code Analyzer Plugin
        run: sf plugins install code-analyzer@latest
      
      - name: Run Salesforce Code Analyzer
        id: code-analyzer
        uses: forcedotcom/run-code-analyzer@v2
        with:
          run-arguments: --workspace . --view detail --output-file sfca_results.json
          results-artifact-name: salesforce-code-analyzer-results
          github-token: ${{ github.token }}
      
      - name: Check for Critical Violations
        run: |
          echo "Code Analyzer Exit Code: ${{ steps.code-analyzer.outputs.exit-code }}"
          echo "Total Violations: ${{ steps.code-analyzer.outputs.num-violations }}"
          echo "Critical (Sev1) Violations: ${{ steps.code-analyzer.outputs.num-sev1-violations }}"
          echo "High (Sev2) Violations: ${{ steps.code-analyzer.outputs.num-sev2-violations }}"
          echo "Medium (Sev3) Violations: ${{ steps.code-analyzer.outputs.num-sev3-violations }}"
          echo "Low (Sev4) Violations: ${{ steps.code-analyzer.outputs.num-sev4-violations }}"
          echo "Info (Sev5) Violations: ${{ steps.code-analyzer.outputs.num-sev5-violations }}"
          
          # Fail build on critical violations (severity 1)
          if [ "${{ steps.code-analyzer.outputs.num-sev1-violations }}" -gt 0 ]; then
            echo "❌ Found ${{ steps.code-analyzer.outputs.num-sev1-violations }} critical violation(s). Failing build."
            exit 1
          fi
          
          # Fail build if analyzer exited with error
          if [ "${{ steps.code-analyzer.outputs.exit-code }}" -ne 0 ]; then
            echo "❌ Code Analyzer exited with error code ${{ steps.code-analyzer.outputs.exit-code }}"
            exit 1
          fi
          
          echo "✅ Code quality check passed - no critical violations found"
  
  deploy:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version
      
      - name: Authenticate Salesforce org
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > /tmp/auth.txt
          sf org login sfdx-url --sfdx-url-file /tmp/auth.txt --alias deploy-org
          rm /tmp/auth.txt
      
      - name: Validate deployment with tests
        run: |
          sf project deploy start \
            --source-dir force-app \
            --target-org deploy-org \
            --test-level RunLocalTests \
            --wait 10 \
            --json > deployment-report.json || DEPLOY_EXIT_CODE=$?
          
          # Check if deployment-report.json exists and has content
          if [ ! -f deployment-report.json ] || [ ! -s deployment-report.json ]; then
            echo "Deployment command failed to generate report"
            exit 1
          fi
      
      - name: Check deployment status
        run: |
          # Install jq for JSON parsing if not available
          sudo apt-get update && sudo apt-get install -y jq || true
          
          # Parse deployment status from JSON report
          if [ -f deployment-report.json ]; then
            DEPLOYMENT_STATUS=$(cat deployment-report.json | jq -r '.status // "unknown"')
            DEPLOYMENT_RESULT=$(cat deployment-report.json | jq -r '.result.status // "unknown"')
            
            echo "Deployment Status Code: $DEPLOYMENT_STATUS"
            echo "Deployment Result: $DEPLOYMENT_RESULT"
            
            # Check if deployment succeeded
            if [ "$DEPLOYMENT_STATUS" != "0" ] || [ "$DEPLOYMENT_RESULT" != "Succeeded" ]; then
              echo "Deployment failed or had warnings"
              cat deployment-report.json | jq '.'
              exit 1
            else
              echo "Deployment succeeded successfully"
              cat deployment-report.json | jq '.result.numberComponentErrors, .result.numberTestsCompleted, .result.numberTestsFailed'
            fi
          else
            echo "Deployment report not found"
            exit 1
          fi
      
      - name: Upload deployment report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.json
          retention-days: 30