name: Salesforce CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SF_CLI_VERSION: latest
  SOURCE_DIR: force-app

jobs:
  code-quality:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üîß Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${{ env.SF_CLI_VERSION }}
          sf --version

      - name: üîå Install Salesforce Code Analyzer Plugin
        run: |
          sf plugins install @salesforce/sfdx-scanner@latest

      - name: üì¶ Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: üîç Run Code Analyzer
        id: code-quality
        continue-on-error: true
        run: |
          # Run scanner and capture output
          sf scanner:run \
            --target "${{ env.SOURCE_DIR }}" \
            --format json \
            --outfile code-quality-report.json || true
          
          # Check for Sev1 issues
          if [ -f code-quality-report.json ]; then
            # Handle different JSON structures from scanner
            SEV1_COUNT=$(jq '[.[] | .violations[]? | select(.severity == 1)] | length' code-quality-report.json 2>/dev/null || \
                        jq '[.[] | select(.severity == 1)] | length' code-quality-report.json 2>/dev/null || \
                        echo "0")
            
            if [ "$SEV1_COUNT" != "0" ] && [ -n "$SEV1_COUNT" ]; then
              echo "‚ùå Found $SEV1_COUNT Sev1 issues. Failing build."
              jq '.[] | .violations[]? | select(.severity == 1)' code-quality-report.json 2>/dev/null || \
              jq '.[] | select(.severity == 1)' code-quality-report.json 2>/dev/null || true
              exit 1
            else
              echo "‚úÖ No Sev1 issues found."
            fi
          else
            echo "‚ö†Ô∏è Code quality report not generated. Continuing..."
          fi

      - name: üìä Upload Code Quality Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: code-quality-report.json
          retention-days: 30

  validate:
    name: ‚úÖ Validate Deployment
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üîß Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${{ env.SF_CLI_VERSION }}
          sf --version

      - name: üîê Authenticate to Salesforce Org
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          if [ -z "$SFDX_AUTH_URL" ]; then
            echo "‚ö†Ô∏è SFDX_AUTH_URL secret not set. Skipping validation."
            exit 0
          fi
          
          echo "$SFDX_AUTH_URL" > auth.txt
          sf org login sfdx-url \
            --sfdx-url-file auth.txt \
            --alias ci-org \
            --set-default

      - name: üì¶ Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: ‚úÖ Validate Deployment
        id: validate
        continue-on-error: true
        run: |
          set +e
          sf project deploy validate \
            --source-dir "${{ env.SOURCE_DIR }}" \
            --test-level RunLocalTests \
            --wait 10 \
            --json > validate-report.json
          VALIDATE_EXIT_CODE=$?
          set -e
          
          # Store exit code for next step
          echo "VALIDATE_EXIT_CODE=$VALIDATE_EXIT_CODE" >> $GITHUB_ENV
          
          # Log the exit code for debugging
          echo "Validation command exit code: $VALIDATE_EXIT_CODE"
          
          # If exit code is 0, validation succeeded regardless of JSON structure
          if [ "$VALIDATE_EXIT_CODE" -eq 0 ]; then
            echo "‚úÖ Validation command completed successfully"
          fi

      - name: üìä Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validate-report
          path: validate-report.json
          retention-days: 30

      - name: üßπ Cleanup Auth Files
        if: always()
        run: |
          rm -f auth.txt

      - name: ‚ùå Fail if Validation Failed
        run: |
          # Check if validation command failed (non-zero exit code)
          if [ "${VALIDATE_EXIT_CODE:-1}" -ne 0 ]; then
            echo "‚ùå Validation command failed with exit code: ${VALIDATE_EXIT_CODE:-1}"
            if [ -f validate-report.json ]; then
              echo "Validation report contents:"
              cat validate-report.json | jq '.' 2>/dev/null || cat validate-report.json
            fi
            exit 1
          fi
          
          # Parse JSON if file exists
          if [ -f validate-report.json ]; then
            # Check for different JSON structures
            STATUS=$(jq -r '.status // .result.status // .result.done // empty' validate-report.json 2>/dev/null || echo "")
            
            # Also check if there are any errors in the response
            HAS_ERRORS=$(jq -r '.result.numberComponentErrors // .numberComponentErrors // 0' validate-report.json 2>/dev/null || echo "0")
            
            echo "Validation status from JSON: $STATUS"
            echo "Component errors: $HAS_ERRORS"
            
            # If status exists and indicates failure, fail the build
            # Note: "0" might be a valid status code, so we check for actual failure statuses
            if [ -n "$STATUS" ] && [ "$STATUS" != "Succeeded" ] && [ "$STATUS" != "true" ] && [ "$STATUS" != "1" ] && [ "$STATUS" != "0" ]; then
              echo "‚ùå Validation failed with status: $STATUS"
              # Show error details if available
              jq -r '.result.details // .details // empty' validate-report.json 2>/dev/null || true
              exit 1
            fi
            
            # Fail if there are component errors
            if [ "$HAS_ERRORS" != "0" ] && [ "$HAS_ERRORS" != "null" ] && [ -n "$HAS_ERRORS" ]; then
              echo "‚ùå Validation found $HAS_ERRORS component errors"
              exit 1
            fi
            
            echo "‚úÖ Validation completed successfully"
          else
            echo "‚ö†Ô∏è Validation report file not found, but command succeeded (exit code: ${VALIDATE_EXIT_CODE:-0})"
          fi

  deploy:
    name: üöÄ Deploy to Org
    runs-on: ubuntu-latest
    needs: [code-quality, validate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üîß Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli@${{ env.SF_CLI_VERSION }}
          sf --version

      - name: üîê Authenticate to Salesforce Org
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          if [ -z "$SFDX_AUTH_URL" ]; then
            echo "‚ùå SFDX_AUTH_URL secret not set. Cannot deploy."
            exit 1
          fi
          
          echo "$SFDX_AUTH_URL" > auth.txt
          sf org login sfdx-url \
            --sfdx-url-file auth.txt \
            --alias deploy-org \
            --set-default

      - name: üì¶ Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: üöÄ Deploy to Salesforce Org
        id: deploy
        continue-on-error: true
        run: |
          sf project deploy start \
            --source-dir "${{ env.SOURCE_DIR }}" \
            --test-level RunLocalTests \
            --wait 10 \
            --json > deploy-report.json || true

      - name: üìä Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-report
          path: deploy-report.json
          retention-days: 30

      - name: üßπ Cleanup Auth Files
        if: always()
        run: |
          rm -f auth.txt

      - name: ‚ùå Fail if Deployment Failed
        run: |
          if [ -f deploy-report.json ]; then
            # Check for component failures (most reliable indicator)
            COMPONENT_FAILURES=$(jq -r '.componentFailures // [] | length' deploy-report.json 2>/dev/null || echo "0")
            
            # Check for test failures
            TEST_FAILURES=$(jq -r '.runTestResult.numFailures // 0' deploy-report.json 2>/dev/null || echo "0")
            
            # Check for component errors count
            HAS_ERRORS=$(jq -r '.result.numberComponentErrors // .numberComponentErrors // 0' deploy-report.json 2>/dev/null || echo "0")
            
            # Check for error messages
            ERROR_MSG=$(jq -r '.message // .result.message // empty' deploy-report.json 2>/dev/null || echo "")
            
            # Check for status (if present)
            STATUS=$(jq -r '.status // .result.status // empty' deploy-report.json 2>/dev/null || echo "")
            
            echo "Component failures: $COMPONENT_FAILURES"
            echo "Test failures: $TEST_FAILURES"
            echo "Component errors: $HAS_ERRORS"
            echo "Status: ${STATUS:-not present}"
            
            # Determine if deployment succeeded
            DEPLOYMENT_SUCCESS=true
            
            # Check for component failures
            if [ "$COMPONENT_FAILURES" != "0" ] && [ "$COMPONENT_FAILURES" != "null" ] && [ -n "$COMPONENT_FAILURES" ]; then
              echo "‚ùå Deployment has $COMPONENT_FAILURES component failures"
              DEPLOYMENT_SUCCESS=false
            fi
            
            # Check for test failures
            if [ "$TEST_FAILURES" != "0" ] && [ "$TEST_FAILURES" != "null" ] && [ -n "$TEST_FAILURES" ]; then
              echo "‚ùå Deployment has $TEST_FAILURES test failures"
              DEPLOYMENT_SUCCESS=false
            fi
            
            # Check for component errors
            if [ "$HAS_ERRORS" != "0" ] && [ "$HAS_ERRORS" != "null" ] && [ -n "$HAS_ERRORS" ]; then
              echo "‚ùå Deployment found $HAS_ERRORS component errors"
              DEPLOYMENT_SUCCESS=false
            fi
            
            # Check for error messages
            if [ -n "$ERROR_MSG" ]; then
              echo "‚ùå Deployment error: $ERROR_MSG"
              DEPLOYMENT_SUCCESS=false
            fi
            
            # Check status if present (but don't fail on "0" as it might be exit code, not status)
            if [ -n "$STATUS" ] && [ "$STATUS" != "Succeeded" ] && [ "$STATUS" != "true" ] && [ "$STATUS" != "1" ] && [ "$STATUS" != "0" ]; then
              echo "‚ö†Ô∏è Status indicates potential issue: $STATUS"
              # Only fail if we have other indicators of failure
              if [ "$COMPONENT_FAILURES" = "0" ] && [ "$TEST_FAILURES" = "0" ] && [ "$HAS_ERRORS" = "0" ]; then
                echo "‚ö†Ô∏è Status is non-standard but no failures detected. Continuing..."
              fi
            fi
            
            # Final decision
            if [ "$DEPLOYMENT_SUCCESS" = "false" ]; then
              echo "‚ùå Deployment failed"
              # Show error details if available
              jq -r '.result.details // .details // empty' deploy-report.json 2>/dev/null || true
              jq '.componentFailures' deploy-report.json 2>/dev/null || true
              exit 1
            else
              echo "‚úÖ Deployment succeeded!"
            fi
          else
            echo "‚ùå Deployment report file not found"
            exit 1
          fi